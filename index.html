<script type="text/babel">
const {useState,useEffect,useRef}=React

function App(){
const [stations,setStations]=useState([])
const [current,setCurrent]=useState(null)
const [playing,setPlaying]=useState(false)
const [fav,setFav]=useState(JSON.parse(localStorage.getItem("fav")||"[]"))
const [dark,setDark]=useState(true)
const [search,setSearch]=useState("")
const audio=useRef(null)
const canvas=useRef(null)
const ctx=useRef(null)

useEffect(()=>{load("Mexico")},[])

async function load(c){
 const r=await fetch("https://de1.api.radio-browser.info/json/stations/bycountry/"+c)
 const d=await r.json()
 setStations(d.filter(s=>s.url_resolved?.startsWith("https")).slice(0,120))
}

function play(s){
 setCurrent(s)
 setTimeout(()=>audio.current.play(),200)
 setPlaying(true)
}

function toggle(s){
 let f
 if(fav.find(x=>x.stationuuid===s.stationuuid)){
  f=fav.filter(x=>x.stationuuid!==s.stationuuid)
 }else f=[s,...fav]
 setFav(f)
 localStorage.setItem("fav",JSON.stringify(f))
}

/* ECUALIZADOR */
useEffect(()=>{
 if(!canvas.current||!audio.current)return
 const AudioCtx=window.AudioContext||window.webkitAudioContext
 const audioCtx=new AudioCtx()
 const src=audioCtx.createMediaElementSource(audio.current)
 const analyser=audioCtx.createAnalyser()
 src.connect(analyser)
 analyser.connect(audioCtx.destination)
 analyser.fftSize=64
 const buffer=new Uint8Array(analyser.frequencyBinCount)
 ctx.current=canvas.current.getContext("2d")

 function draw(){
  requestAnimationFrame(draw)
  analyser.getByteFrequencyData(buffer)
  ctx.current.clearRect(0,0,canvas.current.width,canvas.current.height)
  buffer.forEach((v,i)=>{
   ctx.current.fillStyle="#38bdf8"
   ctx.current.fillRect(i*10,50-v/3,8,v/3)
  })
 }
 draw()
},[current])

const filtered=stations.filter(s=>s.name.toLowerCase().includes(search.toLowerCase()))

return(
<div className={dark?"dark":""}>
<div className="h-screen flex flex-col bg-bg dark:bg-bg bg-white dark:text-white text-black">

<header className="p-3 border-b border-slate-800 flex gap-2 items-center">
<h1 className="font-bold">Radio Arturo</h1>
<input placeholder="Buscar estación..." className="bg-slate-800 text-white px-3 py-1 rounded text-sm flex-1"
value={search} onChange={e=>setSearch(e.target.value)}/>
<button onClick={()=>setDark(!dark)}><i className="ph ph-moon"></i></button>
<button onClick={()=>load("Mexico")}>MX</button>
<button onClick={()=>load("Venezuela")}>VE</button>
</header>

<main className="flex-1 overflow-auto divide-y divide-slate-800">
{filtered.map(s=>(
<div key={s.stationuuid} className="flex items-center p-3 hover:bg-slate-800/40">
<img src={s.favicon||"https://upload.wikimedia.org/wikipedia/commons/8/84/Radio_icon.png"} className="w-10 h-10 rounded"/>
<div onClick={()=>play(s)} className="ml-3 flex-1 truncate cursor-pointer">
<div>{s.name}</div>
<div className="text-xs opacity-60">{s.country}</div>
</div>
<button onClick={()=>toggle(s)} className="text-accent">
<i className={`ph ${fav.find(x=>x.stationuuid===s.stationuuid)?"ph-heart-fill":"ph-heart"}`}></i>
</button>
</div>
))}
</main>

<footer className="border-t border-slate-800 p-3">
{current && <audio ref={audio} src={current.url_resolved} crossOrigin="anonymous"/>}

<div className="flex items-center gap-3">
<img src={current?.favicon} className="w-14 h-14 rounded bg-slate-800"/>
<div className="flex-1">
<div className="font-semibold">{current?.name||"No hay estación"}</div>
<div className="text-xs opacity-60">Now Playing</div>
<canvas ref={canvas} width="320" height="60" className="mt-1"/>
</div>
<button onClick={()=>{playing?audio.current.pause():audio.current.play();setPlaying(!playing)}} className="text-accent text-2xl">
<i className={`ph ${playing?"ph-pause":"ph-play"}`}></i>
</button>
<input type="range" min="0" max="1" step="0.01" onChange={e=>audio.current.volume=e.target.value}/>
</div>
</footer>

</div>
</div>
)
}

ReactDOM.createRoot(document.getElementById("app")).render(<App/>)
</script>
